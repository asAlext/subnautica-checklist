// DonnÃ©es de la checklist pour Subnautica - Version COMPLÃˆTE avec 8 chapitres chronologiques prÃ©cis
const data = {
    chapters: [
        {
            id: "chapitre-1",
            title: "Chapitre 1 : Le Crash et la Survie Initiale",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "RÃ©pare la radio et les systÃ¨mes secondaires de la capsule",
                    "Scanner la faune/flore basique et les fragments initiaux",
                    "RÃ©ponds aux premiers signaux radio (Capsule de survie 3 Ã  proximitÃ©)"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "Autour de la capsule : calcaires (Minerai de titane/Cuivre), grottes sous la capsule (Soufre)",
                    "Capsule de survie 3 pour les fragments de Seaglide et Boussole"
                ]},
                { title: "ğŸ”§ Ã€ crafter (Fabricateur de la capsule)", items: [
                    "RÃ©servoir d'oxygÃ¨ne standard",
                    "Outil de rÃ©paration",
                    "Palme",
                    "Lampe torche",
                    "Scanner",
                    "Couteau de survie"
                ]}
            ]
        },
        {
            id: "chapitre-2",
            title: "Chapitre 2 : Outils Essentiels et MobilitÃ© de Base",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "Explore les grottes pour du Soufre/Champignons acides",
                    "RÃ©ponds aux signaux : Capsule de survie 17",
                    "Scanner les fragments dans les dÃ©bris (pour le DÃ©coupeur laser)",
                    "Collecte Minerai d'argent, Minerai de lithium"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "ForÃªt de varech : dÃ©bris petits/gros pour Propulseur, fragments base",
                    "Plateaux herbeux : Ã©paves pour Seamoth",
                    "Capsule de survie 6 pour Palme ultra glissantes"
                ]},
                { title: "ğŸ”§ Ã€ crafter", items: [
                    "Palme",
                    "Boussole",
                    "Constructeur d'habitat",
                    "Compartiments d'habitat basiques : Ordinateur de base, Lit, Chargeur de batteries",
                    "Seamoth (aprÃ¨s fragments)"
                ]}
            ]
        },
        {
            id: "chapitre-3",
            title: "Chapitre 3 : PremiÃ¨re Base et Ãle du Sunbeam (Profondeur : 0-200 m, Biomes : DÃ©troits sÃ»rs, Ãle flottante)",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "Choisis un spot pour la base",
                    "RÃ©ponds Ã  l'appel du Sunbeam : arrive en <30 min",
                    "Explore l'Ã®le : schiste (lithium/or/diamant)",
                    "Entre dans les grottes de l'Ã®le : sel des dÃ©pÃ´ts, tablettes violettes (x3)",
                    "Plateforme d'exÃ©cution de la quarantaine : insÃ¨re les tablettes violettes, scanne le canon alien, cubes ioniques, active l'arche (tÃ©lÃ©porteur)"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "Ãle du Sunbeam",
                    "Grottes sous l'Ã®le : premiÃ¨re (340, 10, 1030), seconde (360, 120, 1150)",
                    "BÃ¢timent alien"
                ]},
                { title: "ğŸ”§ Ã€ crafter", items: [
                    "Baie de vÃ©hicules mobiles",
                    "Chambre d'immersion",
                    "Combinaison radiologique",
                    "Salle multifonction, Salle de scanner (dÃ©bloquÃ©s via fragments)"
                ]}
            ]
        },
        {
            id: "chapitre-4",
            title: "Chapitre 4 : Abordage de l'Aurora - ExtÃ©rieur et Baies (Profondeur : 100-300 m, Biomes : RÃ©cifs clairsemÃ©s)",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "Approche l'Aurora par l'arriÃ¨re gauche",
                    "Ã‰teins les incendies, rÃ©pare les cÃ¢blages, tue les mobs",
                    "Explore les sÃ©diments : capsules de donnÃ©es temporaires (Bras foreuse PRAWN, Barres de rÃ©acteur)",
                    "Baie de cargaison 3 (code 1454)",
                    "Baie Ã  Seamoth : scanner Module de profondeur MK1"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "ExtÃ©rieur de l'Aurora",
                    "EntrÃ©e frontale",
                    "Salle des machines : rÃ©pare 11 brÃ¨ches"
                ]},
                { title: "ğŸ”§ Ã€ crafter", items: [
                    "Extincteurs",
                    "Canon de propulsion",
                    "Recycleur"
                ]}
            ]
        },
        {
            id: "chapitre-5",
            title: "Chapitre 5 : Abordage de l'Aurora - IntÃ©rieur et Quartiers",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "Bureau d'administration : tÃ©lÃ©charge les donnÃ©es, scanne les posters",
                    "Quartiers d'habitation : Ã©teins les feux, scanne les tables bar/chaises",
                    "Cabines (codes : 1869 cabine 1, 2679 capitaine, 6483 Ã©chantillons) : bagages",
                    "Baie Ã  PRAWN : scanne les combinaisons",
                    "Salle du cÅ“ur : coupe les portes (DÃ©coupeur laser), PDA/code 6483"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "Pont supÃ©rieur, Ponts rÃ©sidentiels",
                    "Baie Ã  PRAWN"
                ]},
                { title: "ğŸ”§ Ã€ crafter", items: [
                    "Station de modification",
                    "Cyclops",
                    "Modules de profondeur MK1/MK2 Seamoth/Cyclops"
                ]}
            ]
        },
        {
            id: "chapitre-6",
            title: "Chapitre 6 : Grotte des champignons-gÃ©lifiÃ©s et Base Degasi",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "Mine le lithium/or/magnÃ©tite (Bras foreuse PRAWN)",
                    "Explore la base Degasi : scanne Salle polyvalente/Observatoire",
                    "Collecte les Å“ufs de crÃ©atures, photos, lits",
                    "RÃ©ponds aux signaux des capsules profondes (ex. Capsule de survie 19 : rÃ©servoir haute capacitÃ©)"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "Grotte des champignons-gÃ©lifiÃ©s",
                    "Base Degasi"
                ]},
                { title: "ğŸ”§ Ã€ crafter", items: [
                    "Combinaison PRAWN",
                    "Bras PRAWN : Foreuse, Grappin",
                    "Centrale thermique, Chargeur de batteries avancÃ©"
                ]}
            ]
        },
        {
            id: "chapitre-7",
            title: "Chapitre 7 : Structures Alien Profondes",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "Champ des os : eau acide, tablettes orange/violettes, scanne fossiles/Å“ufs",
                    "Installation de recherche sur les maladies : scanne les Warpers, infection Kharaa rÃ©vÃ©lÃ©e",
                    "Centrale thermique : mine Kyanite/cubes ioniques, active le tÃ©lÃ©porteur Sunbeam",
                    "DÃ©sactive les champs de force (tablettes)"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "Champ des os",
                    "Installation de recherche sur les maladies",
                    "Centrale thermique"
                ]},
                { title: "ğŸ”§ Ã€ crafter", items: [
                    "Modules de profondeur MK3 (Kyanite)",
                    "Fusil de stase",
                    "Piles ioniques",
                    "Bras dÃ©coupeur laser PRAWN"
                ]}
            ]
        },
        {
            id: "chapitre-8",
            title: "Chapitre 8 : Installation de confinement, GuÃ©rison et Ã‰vasion",
            sections: [
                { title: "ğŸ¯ Ã€ faire / Ã‰tapes dÃ©taillÃ©es", items: [
                    "Mine les gros nÅ“uds de Kyanite",
                    "Installation de confinement primaire : scanne expositions/Å“ufs/fÅ“tus, interagit avec l'Empereur des mers (confiance)",
                    "Incube l'Enzyme 42 (guÃ©rison), dÃ©sactive le canon alien",
                    "RÃ©cupÃ¨re le plan de la FusÃ©e Neptune (terminal Aurora)",
                    "Construis/Active la fusÃ©e : plateforme, rampe, propulseurs, rÃ©servoir carburant, cockpit ; active les modules (Ã©nergie, comms, hydraulique)"
                ]},
                { title: "ğŸ—ºï¸ Ã€ visiter", items: [
                    "Installation de confinement primaire",
                    "Aquarium de l'Empereur"
                ]},
                { title: "ğŸ”§ Ã€ crafter", items: [
                    "Enzymes d'incubation",
                    "Composants de la FusÃ©e Neptune",
                    "Base finale : Salle polyvalente, RÃ©acteur nuclÃ©aire si besoin"
                ]}
            ]
        }
    ]
};

document.addEventListener('DOMContentLoaded', () => {
    const chaptersList = document.getElementById('chapters-list');
    const content = document.getElementById('content');
    const resetLink = document.getElementById('reset-progress');

    let progress = JSON.parse(localStorage.getItem('subnautica-progress')) || {};

    function updateChapterProgress(chapterId) {
        const chapter = data.chapters.find(ch => ch.id === chapterId);
        if (!chapter) return { checked: 0, total: 0 };
        let total = 0;
        let checked = 0;
        chapter.sections.forEach(sec => {
            sec.items.forEach((item, index) => {
                const key = `${chapterId}-${sec.title}-${index}`;
                total++;
                if (progress[key]) checked++;
            });
        });
        return { checked, total };
    }

    function updateGlobalProgress() {
        let total = 0;
        let checked = 0;
        data.chapters.forEach(ch => {
            const p = updateChapterProgress(ch.id);
            total += p.total;
            checked += p.checked;
        });
        const percent = total > 0 ? Math.round((checked / total) * 100) : 0;
        const elem = document.getElementById('global-progress');
        if (elem) {
            elem.textContent = `Progression globale : ${percent}% (${checked}/${total} tÃ¢ches)`;
        }
    }

    // Remplir la sidebar
    data.chapters.forEach(chapter => {
        const li = document.createElement('li');
        const prog = updateChapterProgress(chapter.id);
        const a = document.createElement('a');
        a.href = `#${chapter.id}`;
        a.textContent = `${chapter.title} (${prog.checked}/${prog.total})`;
        a.addEventListener('click', (e) => {
            e.preventDefault();
            renderChapter(chapter);
            window.location.hash = chapter.id;
        });
        li.appendChild(a);
        chaptersList.appendChild(li);
    });

    function renderChapter(chapter) {
        content.innerHTML = '';

        const checkAllBtn = document.createElement('button');
        checkAllBtn.textContent = "Tout cocher ce chapitre";
        checkAllBtn.style.margin = '0 0 20px 0';
        checkAllBtn.style.padding = '10px 20px';
        checkAllBtn.style.background = '#004d40';
        checkAllBtn.style.color = '#b2ebf2';
        checkAllBtn.style.border = '1px solid #00acc1';
        checkAllBtn.style.borderRadius = '8px';
        checkAllBtn.style.cursor = 'pointer';
        checkAllBtn.onclick = () => {
            chapter.sections.forEach(sec => {
                sec.items.forEach((_, index) => {
                    const key = `${chapter.id}-${sec.title}-${index}`;
                    progress[key] = true;
                });
            });
            localStorage.setItem('subnautica-progress', JSON.stringify(progress));
            renderChapter(chapter);
            updateGlobalProgress();
            const link = document.querySelector(`a[href="#${chapter.id}"]`);
            if (link) {
                const prog = updateChapterProgress(chapter.id);
                link.textContent = `${chapter.title} (${prog.checked}/${prog.total})`;
            }
        };
        content.appendChild(checkAllBtn);

        const h2 = document.createElement('h2');
        h2.textContent = chapter.title;
        content.appendChild(h2);

        chapter.sections.forEach(sec => {
            const sectionDiv = document.createElement('div');
            sectionDiv.classList.add('section');
            const h3 = document.createElement('h3');
            h3.textContent = sec.title;
            sectionDiv.appendChild(h3);

            sec.items.forEach((itemObj, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('item');

                // Pas d'icÃ´ne ici pour Ã©viter les problÃ¨mes
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                const key = `${chapter.id}-${sec.title}-${index}`;
                checkbox.checked = !!progress[key];

                checkbox.addEventListener('change', () => {
                    progress[key] = checkbox.checked;
                    localStorage.setItem('subnautica-progress', JSON.stringify(progress));
                    const prog = updateChapterProgress(chapter.id);
                    const link = document.querySelector(`a[href="#${chapter.id}"]`);
                    if (link) link.textContent = `${chapter.title} (${prog.checked}/${prog.total})`;
                    updateGlobalProgress();
                });

                const label = document.createElement('label');
                label.textContent = typeof itemObj === 'string' ? itemObj : itemObj.text;

                itemDiv.appendChild(checkbox);
                itemDiv.appendChild(label);
                sectionDiv.appendChild(itemDiv);
            });

            content.appendChild(sectionDiv);
        });

        document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
        const activeLink = document.querySelector(`a[href="#${chapter.id}"]`);
        if (activeLink) activeLink.classList.add('active');
    }

    const hash = window.location.hash.substring(1);
    let initialChapter = data.chapters.find(ch => ch.id === hash) || data.chapters[0];
    renderChapter(initialChapter);
    updateGlobalProgress();

    resetLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (confirm('Voulez-vous vraiment tout rÃ©initialiser ?')) {
            localStorage.removeItem('subnautica-progress');
            progress = {};
            location.reload();
        }
    });
});
