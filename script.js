// Donn√©es de la checklist pour Subnautica - Version COMPL√àTE
const data = {
    chapters: [
        {
            id: "chapitre-1",
            title: "Chapitre 1 : Le Crash et la Survie Initiale",
            sections: [
                { title: "üéØ Objectif & √âtapes d√©taill√©es", items: [
                    "R√©parer la radio endommag√©e",
                    "Scanner la faune/flore de base",
                    "Collecter des ressources : Quartz (silice), Champi abyssal (champignons), Titane/Cuivre des affleurements calcaires",
                    "Explore autour : r√©colte Minerai de titane, Minerai de cuivre, Quartz, Minerai d'argent, Affleurements calcaires (pour Caoutchouc de silicone, Champignons acides)"
                ]},
                { title: "üîß Crafts essentiels", items: [
                    "Outil de r√©paration",
                    "Couteau de survie",
                    "Palmes",
                    "Lampe torche",
                    "Scanner",
                    "R√©servoir O2 standard"
                ]},
                { title: "üó∫Ô∏è Zones √† explorer", items: [
                    "Bancs calmes (Safe Shallows)"
                ]}
            ]
        },
        {
            id: "chapitre-2",
            title: "Chapitre 2 : Outils Essentiels et Premi√®re Exploration",
            sections: [
                { title: "üéØ √âtapes d√©taill√©es", items: [
                    "Explorer des grottes pour r√©cup√©rer du soufre de cave",
                    "R√©pondre au signal de la Capsules de survie 3 (radio)"
                ]},
                { title: "üó∫Ô∏è Zones", items: [
                    "Capsules de survie 3",
                    "Grottes des Bancs calmes (Safe Shallows)"
                ]}
            ]
        },
        {
            id: "chapitre-3",
            title: "Chapitre 3 : Mobilit√© et Am√©liorations O‚ÇÇ",
            sections: [
                { title: "üéØ √âtapes", items: [
                    "Collecter de l'Argent",
                    "Scanner fragments dispers√©s/√©paves",
                    "R√©pondre √† la Capsules de survie 17 pour le fragments de Seamoth",
                    "Fabrique le Constructeur d'habitat",
                    "Explore pour plans (Canon de propulsion / Canon de r√©pulsion)",
                    "Fabriquer la Combinaison Radiologique compl√®te"
                ]},
                { title: "üîß Crafts cl√©s", items: [
                    "Boussole (databox Capsules de survie 3)",
                    "R√©servoir O‚ÇÇ grande capacit√©",
                    "Canon √† propulsion"
                ]},
                { title: "üó∫Ô∏è Zones", items: [
                    "For√™t de Varech (premi√®res √©paves)"
                    "Plateaux herbeux (Grassy Plateaus)"
                ]}
            ]
        },
        {
            id: "chapitre-4",
            title: "Chapitre 4 : Premi√®re Base et Seamoth",
            sections: [
                { title: "üéØ √âtapes", items: [
                    "Choisir un spot pour une base (pr√®s de titane/cuivre)",
                    "Scanner des fragments de Baie √† v√©hicules mobile",
                    "Scanner des fragments de Seamoth dans des √©paves"
                ]},
                { title: "üîß Crafts", items: [
                    "Salle scanner",
                    "Baie V√©hicules Mobile",
                    "Seamoth"
                ]},
                { title: "üó∫Ô∏è Zones", items: [
                    "√âpaves Plateaux Herbeux pour Seamoth"
                ]}
            ]
        },
        {
            id: "chapitre-5",
            title: "Chapitre 5 : Construction Combinaison PRAWN",
            sections: [
                { title: "üéØ √âtapes", items: [
                    "Explorer zone radiation",
                    "R√©pondre Capsules de survie 19",
                    "Scanner des fragments de la Station de Modification"
                ]},
                { title: "üîß Crafts", items: [
                    "Chambre d'immersion",
                    "Console d'am√©lioration de v√©hicules",
                    "Station de Modification",
                    "Module Profondeur MK1"
                ]},
                
                { title: "üó∫Ô∏è Zones", items: [
                    "R√©cifs clairsem√©s",
                    "Capsules de survie 19"
                ]}
            ]
        },
        {
            id: "chapitre-6",
            title: "Chapitre 6 : Degasi, Sunbeam et Premiers Aliens",
            sections: [
                { title: "üéØ √âtapes", items: [
                    "Suivre balises Degasi : √éle Flottante, Grotte M√©duse, Abysse des Grands r√©cifs",
                    "Aller au site Sunbeam",
                    "Entrer dans la structure avec la tablette violette*",
                    "Scanner l'≈íuf du C√¢lineur"
                ]},
                { title: "üîß Crafts", items: [
                    "Salle Polyvalente, Centrale Thermique, R√©acteur Nucl√©aire",
                    "Fabriquer un Aquariums"
                ]},
                
                { title: "üó∫Ô∏è Zones", items: [
                    "Bases Degasi abandonn√©es",
                    "Structure √©trange (tablette violette)*",
                    "√éle montagneuse"
                ]}
            ]
        },
        {
            id: "materiaux-upgrades",
            title: "Liste Compl√®te Mat√©riaux pour V√©hicules (Base + Tous Am√©liorations)",
            sections: [
                { title: "üöó Seamoth (Base + Toutes les 12 am√©liorations)", items: [
                    "Base : Lingot plasteel x2, Pile √©nergie x1, Puce √©lectronique x1",
                    "Ressources brutes approx. (base) : Minerai de titane x20+, Cuivre x10, Argent x5, Or x2, Plomb x8",
                    "Profondeur MK1 - Plasteel x1, Puce x1, Kit c√¢blage x1",
                    "Profondeur MK2 - Plasteel x1, Puce x1, Magn√©tite x2",
                    "Profondeur MK3 - Plasteel x1, Puce x1, Kyanite x2",
                    "Brut total approx. (tous) : Minerai de titane x100+, Nickel x20, Kyanite x10, etc."
                ]},
                { title: "ü§ñ Combinaison PRAWN (Base + Tous Bras/Modules)", items: [
                    "Base : Lingot plasteel x2, Pile √©nergie x1, Puce √©lectronique x1, Verre √©maill√© x1, A√©rogel x2",
                    "Brut base : Titane x30, Rubis x4, Sac de gel x4",
                    "Bras forage - Plasteel x2, Moteur x2",
                    "Profondeur MK2 - Plasteel x1, Kyanite x4",
                    "Brut total : Titane x80+, Kyanite x20, Rubis x10"
                ]},
                { title: "üõ≥Ô∏è Cyclops (Base + Toutes les 10 am√©liorations)", items: [
                    "Base : Lingot plasteel x4, Pile √©nergie x2, Puce √©lectronique x2, Graisse x1, Verre renforc√© x4",
                    "Brut base : Titane x50+, Quartz x20",
                    "Profondeur MK3 - Plasteel x1 + Kyanite x2",
                    "Brut total : Titane x100+, Kyanite x10, Cubes ion x5"
                ]},
                { title: "üöÄ Fus√©e d'√âvacuation Neptune (Compl√®te)", items: [
                    "Toutes pi√®ces : Lanceur, Gantry, Boosters Ion, R√©serve carburant, Cockpit",
                    "Mat√©riaux agr√©g√©s : Fibre carbone x2, Puce √©lectronique x3, Pile ionique x1, Kyanite x60, etc.",
                    "Brut total : Minerai de titane x100+, Kyanite x60 (Lave), Uranium x2 (Rivi√®re perdue)"
                ]}
            ]
        }
    ]
};

document.addEventListener('DOMContentLoaded', () => {
    const chaptersList = document.getElementById('chapters-list');
    const content = document.getElementById('content');
    const resetLink = document.getElementById('reset-progress');

    let progress = JSON.parse(localStorage.getItem('subnautica-progress')) || {};

    function updateChapterProgress(chapterId) {
        const chapter = data.chapters.find(ch => ch.id === chapterId);
        if (!chapter) return { checked: 0, total: 0 };
        let total = 0;
        let checked = 0;
        chapter.sections.forEach(sec => {
            sec.items.forEach((item, index) => {
                const key = `${chapterId}-${sec.title}-${index}`;
                total++;
                if (progress[key]) checked++;
            });
        });
        return { checked, total };
    }

    function updateGlobalProgress() {
        let total = 0;
        let checked = 0;
        data.chapters.forEach(ch => {
            const p = updateChapterProgress(ch.id);
            total += p.total;
            checked += p.checked;
        });
        const percent = total > 0 ? Math.round((checked / total) * 100) : 0;
        const elem = document.getElementById('global-progress');
        if (elem) {
            elem.textContent = `Progression globale : ${percent}% (${checked}/${total} t√¢ches)`;
        }
    }

    // Remplir sidebar
    data.chapters.forEach(chapter => {
        const li = document.createElement('li');
        const prog = updateChapterProgress(chapter.id);
        const a = document.createElement('a');
        a.href = `#${chapter.id}`;
        a.textContent = `${chapter.title} (${prog.checked}/${prog.total})`;
        a.addEventListener('click', (e) => {
            e.preventDefault();
            renderChapter(chapter);
            window.location.hash = chapter.id;
        });
        li.appendChild(a);
        chaptersList.appendChild(li);
    });

    function renderChapter(chapter) {
        content.innerHTML = '';

        // Bouton "Tout cocher"
        const checkAllBtn = document.createElement('button');
        checkAllBtn.textContent = "Tout cocher ce chapitre";
        checkAllBtn.style.margin = '0 0 20px 0';
        checkAllBtn.style.padding = '10px 20px';
        checkAllBtn.style.background = '#004d40';
        checkAllBtn.style.color = '#b2ebf2';
        checkAllBtn.style.border = '1px solid #00acc1';
        checkAllBtn.style.borderRadius = '8px';
        checkAllBtn.style.cursor = 'pointer';
        checkAllBtn.onclick = () => {
            chapter.sections.forEach(sec => {
                sec.items.forEach((_, index) => {
                    const key = `${chapter.id}-${sec.title}-${index}`;
                    progress[key] = true;
                });
            });
            localStorage.setItem('subnautica-progress', JSON.stringify(progress));
            renderChapter(chapter);
            updateGlobalProgress();
            const link = document.querySelector(`a[href="#${chapter.id}"]`);
            if (link) {
                const prog = updateChapterProgress(chapter.id);
                link.textContent = `${chapter.title} (${prog.checked}/${prog.total})`;
            }
        };
        content.appendChild(checkAllBtn);

        const h2 = document.createElement('h2');
        h2.textContent = chapter.title;
        content.appendChild(h2);

        chapter.sections.forEach(sec => {
            const sectionDiv = document.createElement('div');
            sectionDiv.classList.add('section');
            const h3 = document.createElement('h3');
            h3.textContent = sec.title;
            sectionDiv.appendChild(h3);

            sec.items.forEach((itemObj, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.classList.add('item');

                if (typeof itemObj === 'object' && itemObj.icon) {
                    const icon = document.createElement('img');
                    icon.src = itemObj.icon;
                    icon.classList.add('item-icon');
                    icon.alt = '';
                    itemDiv.appendChild(icon);
                }

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                const key = `${chapter.id}-${sec.title}-${index}`;
                checkbox.checked = !!progress[key];

                checkbox.addEventListener('change', () => {
                    progress[key] = checkbox.checked;
                    localStorage.setItem('subnautica-progress', JSON.stringify(progress));
                    const prog = updateChapterProgress(chapter.id);
                    const link = document.querySelector(`a[href="#${chapter.id}"]`);
                    if (link) link.textContent = `${chapter.title} (${prog.checked}/${prog.total})`;
                    updateGlobalProgress(); // MAJ imm√©diate du compteur dans la sidebar
                });

                const label = document.createElement('label');
                label.textContent = typeof itemObj === 'string' ? itemObj : itemObj.text;

                itemDiv.appendChild(checkbox);
                itemDiv.appendChild(label);
                sectionDiv.appendChild(itemDiv);
            });

            content.appendChild(sectionDiv);
        });

        document.querySelectorAll('nav a').forEach(a => a.classList.remove('active'));
        const activeLink = document.querySelector(`a[href="#${chapter.id}"]`);
        if (activeLink) activeLink.classList.add('active');
    }

    const hash = window.location.hash.substring(1);
    let initialChapter = data.chapters.find(ch => ch.id === hash) || data.chapters[0];
    renderChapter(initialChapter);
    updateGlobalProgress(); // Initial

    resetLink.addEventListener('click', (e) => {
        e.preventDefault();
        if (confirm('Voulez-vous vraiment tout r√©initialiser ?')) {
            localStorage.removeItem('subnautica-progress');
            progress = {};
            location.reload();
        }
    });
});
